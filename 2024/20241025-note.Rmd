---
title: "Homo fecal metabolome IPA Trytophan"
author: "Jinxin Meng"
date: "2024-10-25"
output:
  prettydoc::html_pretty:
    theme: cayman
    highlight: github
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F, eval = F)
```

## Homo fecal metabolome IPA Trytophan, PCA, difference
```{R}
#### PCA ####
# 根据indole化合物的丰度来区分，替换一些样本的分组
info <- read.delim('data/info.txt')
group <- read.delim('data/group.txt')
profile <- read.delim('data/profile.txt', row.names = 1, check.names = F) %>% 
  filter(rownames(.) %in% (filter(info, grepl('Indole', class)) %>% pull(cpd_id)))
plot_PCA(profile, group, add_sample = T, lab_size = 1, aspect_ratio = 4/5)
ggsave('PCA_indole_smps.pdf', width = 9, height = 9)

#### info ####
group_color <- c('CD' = '#E69F00', 'HC' = '#69a7bc')
info <- read.delim('data/info.txt')
group <- read.delim('data/group_rename.txt')
profile <- read.delim('data/profile.txt', row.names = 1, check.names = F) %>% 
  dplyr::select(all_of(group$sample)) 

#### different analysis ####
plsda <- opls(data.frame(t(profile)), y = pull(group, group), orthoI = 0)
diff <- difference_analysis(profile, group, comparison = names(group_color))

diff <- data.frame(vip = plsda@vipVn) %>% 
  rownames_to_column('name') %>% 
  left_join(diff, ., by = 'name') %>% 
  mutate(enriched = ifelse((vip > 1 | padj < 0.05) & log2FC > 0, 'CD', 
                           ifelse((vip > 1 | padj < 0.05) & log2FC < 0, 'HC', 'none'))) %>% 
  left_join(info, c('name' = 'cpd_id'))
write.xlsx(diff, 'diff.xlsx')

plot_data <- diff %>% 
  select(name, cpd_name, padj, log2FC, enriched) %>% 
  mutate(.enriched = ifelse(is.na(enriched), 'none', enriched),
         .padj = -log10(padj),
         .log2FC = ifelse(log2FC < -3.9, 3.9, log2FC),
         .label = ifelse(.padj > 2.7, cpd_name, ''))
  
ggscatter(plot_data, 'log2FC', '.padj', color = '.enriched',size = 1, 
          xlab = 'log2FoldChange', ylab = '-log10 P-adjust',
          palette = c(group_color, 'none' = 'grey')) +
  geom_text(aes(label = .label), size = 3) +
  geom_hline(yintercept = -log10(0.05), linetype = 'dashed') +
  geom_vline(xintercept = c(0), linetype = 'dashed') +
  theme(aspect.ratio = 1, 
        axis.ticks.length = unit(2, 'mm'))
ggsave('diff.volcano.pdf', width = 5, height = 5)

#### KEGG enrichment ####
bg_data <- read.delim('/database/KEGG/enrichment_analysis/cpd2path_enrichment.tsv')

profile_x <- profile[filter(info, KEGG != '') %>% pull('cpd_id'), ]
plsda <- opls(data.frame(t(profile_x)), y = pull(group, group), orthoI = 0)
diff <- difference_analysis(profile_x, group, comparison = names(group_color))
diff <- data.frame(vip = plsda@vipVn) %>% 
  rownames_to_column('name') %>% 
  left_join(diff, ., by = 'name') %>% 
  mutate(enriched = ifelse((vip > 1 | padj < 0.05) & log2FC > 0, 'CD', 
                           ifelse((vip > 1 | padj < 0.05) & log2FC < 0, 'HC', 'none'))) %>% 
  left_join(info, c('name' = 'cpd_id'))

eKEGG <- diff %>% 
  filter(enriched != 'none') %>% 
  filter(KEGG != '') %>% 
  pull(KEGG) %>% 
  enricher(TERM2GENE = bg_data, minGSSize = 1, maxGSSize = 1000, 
           pvalueCutoff = 1, qvalueCutoff = 1) %>% 
  data.frame
write.xlsx(eKEGG, file = 'diff.eKEGG.xlsx')

kegg_info <- read.delim('/database/KEGG/v20230401/path_description') %>% 
  filter(category == 'Metabolism')

paths <- c('map00270','map00230','map00350','map00680','map00380',
           'map00340','map00460','map00920','map00650','map00010')

plot_data <- eKEGG %>% 
  mutate(geneRatio = map_vec(strsplit(GeneRatio, '/'), \(x) as.numeric(x[1])/as.numeric(x[2])),
         KEGG = map_vec(strsplit(ID, ':'), \(x) x[1])) %>% 
  filter(KEGG %in% kegg_info$name & qvalue < 0.1) %>% 
  filter(KEGG %in% paths) %>% 
  arrange(geneRatio)

ggscatter(plot_data, 'ID', 'geneRatio', fill = 'qvalue', rotate = T, size = 5,
          shape = 21, legend = 'right', xlab = '', ylab = 'Gene Ratio') +
  scale_fill_viridis_c(begin = .6) +
  theme(aspect.ratio = 2)
ggsave('diff.eKEGG.pdf', width = 7, height = 4.5)

#### correlation PR vs. IPA ####
data <- read.delim('data/data_PR_IPA.txt')

ggscatter(data, 'abso_ab', y = 'content', color = '#ec6644', 
          add = 'reg.line', ylab = 'concentration of IPA (umol/g)', 
          xlab = 'log10 (genomic DNA copies/mg feces) of P. russellii',
          cor.coef = T, cor.method = 'spearman', cor.coef.coord = c(1, 0.015)) +
  ggpmisc::stat_poly_eq(aes(label = paste(after_stat(eq.label), 
                                          after_stat(adj.rr.label), 
                                          after_stat(p.value.label), sep = '~~~~')), 
                        formula = y ~ x) +
  theme(aspect.ratio = 1)

ggsave('PR_IPA.pdf', width = 4, height = 4)

#### BHB concentration ####
plot_data <- profile %>% 
  filter(rownames(.) %in% c('HMDB0000011', 'HMDB0002302')) %>% 
  t %>% 
  data.frame() %>% 
  rownames_to_column('sample') %>% 
  left_join(group, by = 'sample')

ggboxplot(plot_data, 'group', 'HMDB0000011', fill = 'group', legend = 'none',
          xlab = '', size = .5, width = .6, palette = group_color,
          ylab = 'Content (umol/g)', outlier.shape = NA,  
          title = '3-Hydroxybutyric acid') +
  geom_jitter(aes(color = group), width = .15) +
  lims(y = c(NA, .43)) +
  stat_compare_means(comparisons = list(names(group_color)), label = 'p.signif', 
                     tip.length = .02, size = 5, vjust = .5, method = 'wilcox',
                     label.y = .39) +
  theme(aspect.ratio = 1.5) +
  theme(plot.title = element_text(hjust = .5, face = 'bold'))
ggsave('MBT_ab.boxplot.Hydroxybutyric.pdf', width = 3, height = 4)

ggboxplot(plot_data, 'group', 'HMDB0002302', fill = 'group', legend = 'none',
          xlab = '', size = .5, width = .6, palette = group_color,
          ylab = 'Content (umol/g)', outlier.shape = NA,  
          title = 'Indole-3-propionic acid') +
  geom_jitter(aes(color = group), width = .15) +
  lims(y = c(NA, .035)) +
  stat_compare_means(comparisons = list(names(group_color)), label = 'p.signif', 
                     tip.length = .02, size = 5, vjust = .5, method = 'wilcox',
                     label.y = .032) +
  theme(aspect.ratio = 1.4) +
  theme(plot.title = element_text(hjust = .5, face = 'bold'))
ggsave('MBT_ab.boxplot.IPA.pdf', width = 3, height = 4)

#### diff volcano v2 ####
diff <- read.xlsx('diff.xlsx')

plot_data <- diff %>% 
  dplyr::select(name, cpd_name, padj, log2FC, enriched) %>% 
  mutate(.enriched = ifelse(is.na(enriched), 'none', enriched),
         .padj = -log10(padj),
         .log2FC = ifelse(log2FC < -3.9, 3.9, log2FC),
         .label = ifelse(.padj > 2.5, cpd_name, ''),
         .label = ifelse(cpd_name == '3-Hydroxybutyric acid', 
                         '3-Hydroxybutyric acid', .label))

ggscatter(plot_data, 'log2FC', '.padj', color = '.enriched',size = 1, 
          xlab = 'log2FoldChange', ylab = '-log10 P-adjust',
          palette = c(group_color, 'none' = 'grey')) +
  geom_text(aes(label = .label), size = 3) +
  geom_hline(yintercept = -log10(0.05), linetype = 'dashed') +
  geom_vline(xintercept = c(0), linetype = 'dashed') +
  theme(aspect.ratio = 1)
ggsave('diff.volcano2.pdf', width = 5, height = 5)

```