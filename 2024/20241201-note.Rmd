---
title: "STFSV infection Homo public MBX dataset"
author: "Jinxin Meng"
date: "2024-12-01"
output:
  prettydoc::html_pretty:
    theme: cayman
    highlight: github
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F, eval = F)
```

## XieJ_2023 

```{R}
#### PCA ####
gp_col <- c('SF' = '#fc8d62', 'NonSF' = '#66c2a5')

profile <- read.delim("../data/profile.txt", row.names = 1) %>% 
  profile_transRA()
group <- read.delim("../data/group.txt") %>% 
  select(sample, group = group2) %>% 
  mutate(group = factor(group, names(gp_col)))

# 监督分组以疾病-健康为例，orthoI = NA 时执行 OPLS-DA, 自动计算正交分量的数量；默认设置为0，执行的是PLS分析
plsda <- opls(x = data.frame(t(profile), check.names = F), orthoI = 0, predI = 2)

pca_point <- data.frame(plsda@scoreMN) %>% 
  rownames_to_column('sample') %>% 
  left_join(group, by = "sample")
pca_labs <- paste0(c('PC1', 'PC2'), ' (', plsda@modelDF$R2X * 100, '%)')

ggscatter(pca_point, 'p1', 'p2', color = 'group', palette = gp_col, size = 1,
          xlab = pca_labs[1], ylab = pca_labs[2]) +
  stat_ellipse(aes(color = group, fill = group), geom = 'polygon', level = 0.9, 
               alpha = .05, lty = 2, lwd = .3, show.legend = F) +
  theme(aspect.ratio = .9)
ggsave("PCA.pdf", width = 5, height = 5)

#### diff ####
profile <- read.delim("../data/profile.txt", row.names = 1) %>% 
  profile_transRA()
group <- read.delim("../data/group.txt") %>% 
  select(sample, group = group2) %>% 
  mutate(group = factor(group, names(gp_col)))

oplsda <- opls(x = data.frame(t(profile), check.names = F), pull(group, group), orthoI = NA, predI = 1)
  
diff <- difference_analysis(profile, group, gp = names(gp_col), diff_method = "wilcox") %>%
  rename(cpd_id = 'name')
  
out <- oplsda@vipVn %>% 
  data.frame(vip = .) %>% 
  rownames_to_column(var = "cpd_id") %>% 
  left_join(diff, ., by = "cpd_id") %>% 
  left_join(metabolite_info, ., by = 'cpd_id')

saveRDS(out, 'diff.rds')
openxlsx::write.xlsx(out, file = "diff.xlsx")

#### volcano ####
diff <- readRDS("diff.rds")

plot_data <- diff %>% 
  filter(!is.na(log2FC)) %>% 
  select(cpd_id, log2FC, pval, vip) %>% 
  mutate(pval2 = -log10(pval),
         sig = ifelse(pval < 0.05 | vip > 1, 'yes', 'no'),
         enriched = ifelse(sig == 'yes' & log2FC > 0, 'SF', 
                           ifelse(sig == 'yes' & log2FC < 0, 'NonSF', 'none'))) %>% 
  within(., {
    pval2[pval2 > 25] = 25
    log2FC[log2FC > 2] = 2
    log2FC[log2FC < -2] = -2
  } )

ggscatter(plot_data, "log2FC", "pval2", color = "enriched", 
          xlab = 'log2FoldChange', ylab = "-log10 P-value",
          palette = c(gp_col, 'none' = 'grey'), size = 1) +
  geom_hline(yintercept = -log10(0.05), linetype = "dashed") +
  theme(aspect.ratio = 1)
ggsave("volcano.SF_vs_NonSF.pdf", width = 3.6, height = 4)

#### enrichment analysis ####
bg_data <- read.delim("/database/KEGG/enrichment_analysis/cpd2path_enrichment.tsv")

diff <- readRDS("diff.rds") %>% 
  filter(FC > 0.5 & (vip > 2 | padj < 0.001)) %>% 
  filter(KEGG_ID != "")
eKEGG <- enricher(gene = unique(diff$KEGG), TERM2GENE = bg_data, minGSSize = 1, pvalueCutoff = 1, qvalueCutoff = 1)

saveRDS(eKEGG@result, 'eKEGG.rds')
openxlsx::write.xlsx(eKEGG@result, file = "eKEGG.xlsx")

#### visual enrichment ####
keggs <- read.delim("/database/KEGG/v20230401/path_description")
eKEGG <- readRDS('eKEGG.rds')

plot_data <- eKEGG %>% 
  mutate(name = stringr::str_extract(ID, 'map\\d+'), .before = 1) %>% 
  left_join(select(keggs, name, category), by = 'name') %>% 
  filter(category == 'Metabolism' & 
           name %in% c('map00310','map00380','map00360','map00300','map01200','map00650','map00830','map00220')) %>% 
  select(name = Description, GeneRatio, pvalue) %>% 
  mutate(GeneRatio = as.numeric(stringr::str_split_i(GeneRatio, "/", 1)) /
           as.numeric(stringr::str_split_i(GeneRatio, "/", 2))) %>% 
  mutate(pvalue = round(pvalue, 3),
         GeneRatio = GeneRatio + rnorm(nrow(.), mean = 0, sd = .005)) %>% 
  arrange(desc(GeneRatio))

ggscatter(plot_data, "name", "GeneRatio", fill = "pvalue", rotate = T, size = 5,
          shape = 21, legend = 'right', xlab = '', ylab = 'Gene Ratio') +
  scale_fill_viridis_c(begin = .6)
ggsave("eKEGG.SF_vs_NonSF.pdf", width = 5.6, height = 4)

```
