---
title: "scRNASeq SFTS Homo PBMC in public datasets LiJL - IDO / AHR - focus on monocytes"
author: "Jinxin Meng"
date: "2025-07-29"
output:
  prettydoc::html_pretty:
    theme: cayman
    highlight: github
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = F, message = F, eval = F)
```

## LiH_2021

```{R}
#### Monocyte ####
seurat <- readRDS('../../20250707/LiH_2021/seurat.out.rds')
seurat$cell <- seurat@active.ident

seurat <- subset(seurat, cell %in% c('CD14_monocyte', 'CD16_monocyte'))

seurat <- NormalizeData(seurat, normalization.method = 'LogNormalize', scale.factor = 1e4, verbose = T) # 标准化
seurat <- FindVariableFeatures(seurat, selection.method = 'vst', nfeatures = 2000) # 筛选高变基因
VariableFeaturePlot(seurat, cols = c('grey','red'))
seurat <- ScaleData(seurat) # 数据归一化，这步骤有一步回归的分析，去除噪声
seurat <- RunPCA(seurat, features = VariableFeatures(seurat)) # PCA线性降维分析
ElbowPlot(seurat, ndims = 30) # 流石图协助选择PC维度 10
seurat <- RunHarmony(seurat, 'orig.ident') # Harmony去批次
seurat <- RunUMAP(seurat, dims = 1:18, reduction = 'harmony')
seurat <- RunTSNE(seurat, dims = 1:18, reduction = 'harmony')
seurat <- FindNeighbors(seurat, reduction = 'harmony', dims = 1:18)
seurat <- FindClusters(seurat, resolution = c(seq(0, 1.9, .2)))

map2(paste0('RNA_snn_res.', seq(0, 1.9, .2)), paste0('SNN: ', seq(0, 1.9, .2)), ~
       DimPlot(seurat, reduction = 'tsne', group.by = .x, label = T) +
       ggtitle(.y) + 
       theme(aspect.ratio = 1) + 
       guides(color = 'none')) %>% 
  plot_grid(plotlist = ., nrow = 2)
ggsave('tsne.SNN.dimplot.jpg', width = 20, height = 8)

#### 细胞标记 ####  
# 细胞基因标记
markers <- list(
  CD8_T_cell = c('CD3D','CD8A','CD8B','CD3E','CD3'), 
  CD4_T_cell = c('CD3D','CD4','IL7R','LTB','CD3'), 
  gdT_cell = c('TRDV2','TRGV9'),
  NK_cell = c('NCAM1','KLRF1','FGFBP2','FCG3RA','CX3CR1','GNLY','NKG7','TYOBP','PRF1'), 
  B_cell = c('CD19','CD79A','CD79B','MS4A1'), # CD20->MS4A1
  Plasmablast = c('XBP1','RF4','PRDM1','PAX5'), # 浆母细胞
  Plasma_cell = c('CD79A','IGHG1','MZB1','SDC1'), # 浆细胞
  Neutrophils = c('FCGR3B','MMP9','CST3','LYZ','CSF3R'),
  CD14_monocyte = c('CD14','LYZ','CD33','FCN1'),
  CD16_monocyte = c('CD14','FCGR3A','CD33','LYN'), # FCGR3A -> CD
  M1_Macrophage = c('CD80','CD86','INOS'), # 经典激活型巨噬细胞（classically activated macrophages）
  M2_Macrophage = c('CD163','CD206'), # 交替激活型巨噬细胞（alternatively activated macrophages）
  Endothelial_cell = c('PTPRB','PECAM1'),
  Platelet = c('PPBP','CD41'), # 血小板
  Epithelial_cell = c('EPCAM','CK13','CK5'), # 上皮细胞
  Erythroblast = c('MKI67','HBA1','HBB'), # 成红血细胞，红细胞成熟过程中的特定阶段细胞
  cDendritic_cell1 = c('CLEC9A','CADM1'), # conventional dendritic 传统树突状细胞1
  cDendritic_cell2 = c('CST3','COTL1','LYZ','DMXL2','CLEC10A','FCER1A'), # conventional dendritic 传统树突状细胞1
  pDendritic_cell = c('IL3RA','GZMB','SERPINF1','ITM2C'), # plasmacytoid dendritic 浆细胞样树突状细胞
  HSC = c('NRIP1','MECOM','PROM1','NKAIN2','CD34') # Hematopoietic Stem Cell 造血干细胞
  )

# featureplot
markers <- map(markers, \(x) x[x %in% rownames(seurat)])
max_len <- map_vec(markers, ~ length(.x)) %>% max()
map2(markers, names(markers), \(x, y) {
  p_text <- list(ggtext(data.frame(x = 1, y = 1), 'x', 'y', size = 14, face = 'bold',
                        label = stringr::str_to_title(gsub('_', ' ', y))) + 
                   theme_void())
  p_feats <- map(x, ~ FeaturePlot(seurat, reduction = 'tsne', features = .x) +
                   theme(aspect.ratio = 1))
  p_void <- list(ggtext(data.frame(x = 1, y = 1), 'x', 'y', size = 14, face = 'bold') + 
                   theme_void())
  cowplot::plot_grid(plotlist = c(p_text, p_feats, rep(p_void, times = max_len - length(x))),
                     nrow = 1) } ) %>% 
  cowplot::plot_grid(plotlist = ., align = 'v', ncol = 1)
ggsave('tsne.featureplot.jpg', width = 4.5 * (max_len + 1), height = 4.5 * length(markers),
       limitsize = F)

# marker2 
markers <- list(
  CD14_monocyte = c('CD14','LYZ','CD33','FCN1'),
  CD16_monocyte = c('CD14','FCGR3A','CD33','LYN') # FCGR3A -> CD
)

markers <- map(markers, \(x) x[x %in% rownames(seurat)])
max_len <- map_vec(markers, ~ length(.x)) %>% max()
plots <- map2(markers, names(markers), \(x, y) {
  p_text <- list(ggtext(data.frame(x = 1, y = 1), 'x', 'y', size = 14, face = 'bold',
                        label = stringr::str_to_title(gsub('_', ' ', y))) + 
                   theme_void())
  p_feats <- map(x, ~ FeaturePlot(seurat, reduction = 'umap', features = .x) +
                   theme(aspect.ratio = 1))
  p_void <- list(ggtext(data.frame(x = 1, y = 1), 'x', 'y', size = 14, face = 'bold') + 
                   theme_void())
  cowplot::plot_grid(plotlist = c(p_text, p_feats, rep(p_void, times = max_len - length(x))), nrow = 1) } )
pdf('umap.featureplot.pdf', width = 4.5 * (max_len + 1), height = 4.5)
plots
dev.off()

seurat <- SetIdent(seurat, value = 'RNA_snn_res.0.8')
DimPlot(seurat, reduction = 'tsne', label = T, alpha = 1, raster = F) + 
  NoLegend() + theme(aspect.ratio = 1)
ggsave('tsne.SNN.0.8.dimplot.pdf', width = 6, height = 6)

# 鉴定每个cluster中的marker
allmarkers <- FindAllMarkers(seurat, only.pos = T, min.pct = 0.25, logfc.threshold = 0.25)
saveRDS(allmarkers, 'allmarkers.cluster.rds')
write.xlsx(allmarkers, 'allmarkers.cluster.xlsx')

#### 细胞注释 ####
# CD14/CD16 markers
plot_data <- FetchData(seurat, vars = c('CD14', 'FCGR3A')) %>% 
  add_column(cell = seurat@active.ident) %>% 
  gather(key = 'gene', value = 'value', -cell)

ggplot(plot_data, aes(cell, value), color = factor(cell)) +
  geom_violin(aes(fill = cell), scale ='width') +
  facet_grid(gene ~ ., scales = 'free_y') +
  scale_y_continuous(expand = c(0, 0)) +
  scale_fill_manual(values = pald('rainbow3', 16)) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.title = element_blank(),
        axis.ticks.length = unit(1.6, 'mm'),
        axis.text = element_text(color = 'black', size = 10),
        legend.position = 'none',
        panel.spacing.y = unit(0, 'cm'),
        strip.text.y = element_text(angle = 0, size = 12, hjust = 0, face = 'italic'),
        strip.background.y = element_blank())
ggsave('violinplot.cluster.CD1x.pdf', width = 6, height = 3)

p1 <- FeaturePlot(seurat, reduction = 'tsne', features = c('CD14'),cols = c('#ffffff', '#225ea8')) +
  labs(title = 'CD14') +
  theme(aspect.ratio = 1,
        axis.ticks.length = unit(2, 'mm'),
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 10),
        plot.title = element_text(size = 12))
p2 <- FeaturePlot(seurat, reduction = 'tsne', features = 'FCGR3A', cols = c('#ffffff', '#225ea8')) +
  labs(title = 'CD16 (FCGR3A)') +
  theme(aspect.ratio = 1,
        axis.ticks.length = unit(2, 'mm'),
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 10),
        plot.title = element_text(size = 12))
cowplot::plot_grid(p1, p2)
ggsave('tsne.featureplot.CD1x.pdf', width = 9, height = 4)

# marker自动注释
map(markers, ~ filter(allmarkers, gene %in% .x) ) %>% 
  keep(~ nrow(.x) != 0) %>% 
  map(~ group_by(.x, cluster) %>% 
        group_modify(~ data.frame(match_n = nrow(.x), 
                                  genes = paste(.x$gene, collapse = ',')))) %>% 
  map2_df(names(.), ~ add_column(.x, gene = .y, .before = 1)) %>% 
  data.frame() %>% 
  arrange(cluster)

# 经典单核细胞 (Classical): CD14hi CD16-，约占单核细胞的90%，具有较强的吞噬和抗菌活性。 
# 中间单核细胞 (Intermediate): CD14hi CD16+，具有较高的CD14和相对低的CD16表达，约占单核细胞的10%。 
# 非经典单核细胞 (Non-classical): CD14-/low CD16+，相对较低的CD14表达和高CD16表达，主要在血管巡逻和监视中发挥作用。
# 这些亚群在免疫系统中发挥不同的功能，参与宿主的促炎防御机制、抗原呈递和监视等。
seurat <- RenameIdents(seurat,
                       '0' = 'Classical', '1' = 'Classical', '2' = 'Non-classical', 
                       '3' = 'Classical', '4' = 'Classical', '5' = 'Non-classical',
                       '6' = 'Intermediate', '7' = 'Intermediate', '8' = 'CD8_T_cell', 
                       '9' = 'Non-classical', '10' = 'Classical', '11' = 'naive_Tcell',
                       '12' = 'Classical', '13' = 'Classical', '14' = 'CD4_T_cell', 
                       '15' = 'Megakaryocyte')

# 疑难细胞群注释
filter(allmarkers, p_val_adj < 0.01 & cluster == '15') %>% 
  pull() %>% 
  scRNA_marker_match(tissue = 'peripheral_blood', org = 'human') %>% 
  select(-species, -tissue, -cell, -gene) %>% 
  filter(grepl('blood', item)) %>% 
  data.frame() %>% 
  head(10)

# 可视化
DimPlot(seurat, reduction = 'tsne', label = T, alpha = 1, cols = 'Set3', raster = F) + 
  theme(aspect.ratio = 1) + NoLegend()
ggsave('tsne.marker.dimplot.pdf', width = 6, height = 6)

DimPlot(seurat, reduction = 'tsne', label = T, alpha = 1, split.by = 'group', raster = F,
        cols = 'Set3', label.size = 3) + theme(aspect.ratio = 1)
ggsave('tsne.marker.dimplot.facet_by_group.pdf', width = 20, height = 5)

# 差异基因
allmarkers <- FindAllMarkers(seurat, only.pos = T, min.pct = 0.25, logfc.threshold = 0.25)
saveRDS(allmarkers, 'allmarkers.cell.rds')
write.xlsx(allmarkers, 'allmarkers.cell.xlsx')

# CD14/CD16 markers
plot_data <- FetchData(seurat, vars = c('CD14', 'FCGR3A')) %>% 
  add_column(cell = seurat@active.ident) %>% 
  gather(key = 'gene', value = 'value', -cell)

ggplot(plot_data, aes(cell, value), color = factor(cell)) +
  geom_violin(aes(fill = cell), scale ='width') +
  facet_grid(gene ~ ., scales = 'free_y') +
  scale_y_continuous(expand = c(0, 0)) +
  scale_fill_manual(values = colorRampPalette(pald('rainbow3'))(7)) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.title = element_blank(),
        axis.ticks.length = unit(1.6, 'mm'),
        axis.text = element_text(color = 'black', size = 10),
        axis.text.x = element_text(color = 'black', size = 10, angle = 45, hjust = 1),
        legend.position = 'none',
        panel.spacing.y = unit(0, 'cm'),
        strip.text.y = element_text(angle = 0, size = 12, hjust = 0, face = 'italic'),
        strip.background.y = element_blank())
ggsave('violinplot.cell.CD1x.pdf', width = 4, height = 3)

# 保存seurat对象
saveRDS(seurat, 'seurat.out.rds')

#### 差异分析 ####
group_level <- c('RS', 'AS', 'AD')
cell_level <- levels(Idents(seurat))[1:3]

# 所有细胞类型
diffs <- map(cell_level, \(x) 
             map(group_level, \(y) 
                 FindMarkers(subset(seurat, idents = x), ident.1 = y,
                             ident.2 = 'HC', group.by = 'group') %>% 
                   rownames_to_column('name')) %>%
               set_names(paste0(group_level, '_vs_HC')) ) %>% 
  set_names(cell_level)
saveRDS(diffs, 'diffs.rds')

diffs <- list_flatten(diffs)
write.xlsx(diffs, 'diffs.xlsx')

#### GSEA KEGG ####
options(clusterProfiler.download.method = 'curl', timeout = 120)
pacman::p_load(org.Hs.eg.db, clusterProfiler, BiocParallel, enrichplot)
register(SerialParam())

gene_info <- AnnotationDbi::select(org.Hs.eg.db, keys(org.Hs.eg.db), 
                                   keytype = 'ENTREZID', columns = c('SYMBOL'))

download_KEGG('hsa')

gseKEGG <- map(diffs, ~ mutate(.x, ENTREZID = gene_info$ENTREZID[match(name, gene_info$SYMBOL)]) %>%
                 filter(!is.na(ENTREZID)) %>% 
                 pull(avg_log2FC, name = ENTREZID) %>% 
                 sort(decreasing = T) %>% 
                 gseKEGG(organism = 'hsa', pvalueCutoff = 1) %>% 
                 data.frame() )
write.xlsx(gseKEGG, 'diffs.gseKEGG.xlsx')

# 气泡图
kegg_info <- read.delim('/database/KEGG/map/br08901.tsv') %>% 
  mutate(lvC = gsub('map', 'hsa', lvC))

colors <- c('Cellular Processes' = '#66c2a5',
            'Environmental Information Processing' = '#fc8d62',
            'Genetic Information Processing' = '#8da0cb',
            'Metabolism' = '#e78ac3',
            'Organismal Systems' = '#A6D854')

plot_data <- map2_df(gseKEGG, names(gseKEGG), \(x, y)
                     dplyr::filter(data.frame(x)) %>% 
                       dplyr::select(name = Description, id = ID, NES, p.adjust) %>% 
                       data.frame(row.names = NULL) %>% 
                       add_column(group = y) ) %>% 
  left_join(kegg_info, by = c('id' = 'lvC')) %>% 
  filter(lvA %in% c('Metabolism','Genetic Information Processing',
                    'Environmental Information Processing', 'Cellular Processes',
                    'Organismal Systems')) %>% 
  arrange(lvA) %>% 
  mutate(name = factor(name, unique(name)),
         color = colors[lvA],
         name = glue::glue('<p style="color:{color}">{name} </p>') ) %>% 
  mutate(plab = ifelse(p.adjust < 0.05, 'sign', 'non-sign')) %>% 
  filter(p.adjust < 0.05) %>% 
  arrange(group)

ggscatter(plot_data, 'group', 'name', fill = 'NES', shape = 21, 
          xlab = '', ylab = '', size = 3) +
  scale_fill_gradient2(high = '#d53e4f', mid = '#ffffbf', low = '#3288bd') +
  coord_fixed() +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        axis.text.y = ggtext::element_markdown(size = 8),
        axis.ticks.length = unit(1.6, 'mm'),
        panel.spacing.x = unit(0, 'cm'),
        panel.grid = element_line(linewidth = .3, linetype = 'dashed'))
ggsave('diffs.gseKEGG.pdf', width = 6, height = 14)

#### ORA KEGG ####
eKEGG <- map(diffs, ~ filter(.x, p_val_adj < .05 & abs(avg_log2FC) > .25) %>% 
               mutate(ENTREZID = gene_info$ENTREZID[match(name, gene_info$SYMBOL)]) %>%
               pull(ENTREZID) %>% 
               na.omit %>% 
               enrichKEGG(organism = 'hsa', pvalueCutoff = 1, qvalueCutoff = 1) %>% 
               data.frame(row.names = NULL) ) %>% 
  keep(~ nrow(.x) != 0)
write.xlsx(eKEGG, 'diffs.eKEGG.all_gene.xlsx')

# up genes
eKEGG <- map(diffs, ~ filter(.x, p_val_adj < .05 & avg_log2FC > .25) %>% 
               mutate(ENTREZID = gene_info$ENTREZID[match(name, gene_info$SYMBOL)]) %>%
               pull(ENTREZID) %>% 
               na.omit %>% 
               enrichKEGG(organism = 'hsa', pvalueCutoff = 1, qvalueCutoff = 1) %>% 
               data.frame(row.names = NULL) ) %>% 
  keep(~ nrow(.x) != 0)
write.xlsx(eKEGG, 'diffs.eKEGG.up_gene.xlsx')

# down genes
eKEGG <- map(diffs, ~ filter(.x, p_val_adj < .05 & avg_log2FC < -.25) %>% 
               mutate(ENTREZID = gene_info$ENTREZID[match(name, gene_info$SYMBOL)]) %>%
               pull(ENTREZID) %>% 
               na.omit %>% 
               enrichKEGG(organism = 'hsa', pvalueCutoff = 1, qvalueCutoff = 1) %>% 
               data.frame(row.names = NULL) ) %>% 
  keep(~ nrow(.x) != 0)
write.xlsx(eKEGG, 'diffs.eKEGG.down_gene.xlsx')

#### ORA GO ####
# total genes
eGO <- map(diffs, ~ filter(.x, p_val_adj < .05 & abs(avg_log2FC) > .25) %>% 
             pull(name) %>% 
             enrichGO(OrgDb = 'org.Hs.eg.db', keyType = 'SYMBOL',
                      pvalueCutoff = .2, qvalueCutoff = .2, ont = 'ALL') %>% 
             data.frame(row.names = NULL) ) %>% 
  keep(~ nrow(.x) != 0)
write.xlsx(eGO, 'diffs.eGO.all_gene.xlsx')

# up genes
eGO <- map(diffs, ~ filter(.x, p_val_adj < .05 & avg_log2FC > .25) %>% 
             pull(name) %>% 
             na.omit %>% 
             enrichGO(OrgDb = 'org.Hs.eg.db', keyType = 'SYMBOL',
                      pvalueCutoff = .2, qvalueCutoff = .2, ont = 'ALL') %>% 
             data.frame(row.names = NULL) ) %>% 
  keep(~ nrow(.x) != 0)
write.xlsx(eGO, 'diffs.eGO.up_gene.xlsx')

# down genes
eGO <- map(diffs, ~ filter(.x, p_val_adj < .05 & avg_log2FC < -.25) %>% 
             pull(name) %>%  
             na.omit %>% 
             enrichGO(OrgDb = 'org.Hs.eg.db', keyType = 'SYMBOL',
                      pvalueCutoff = .2, qvalueCutoff = .2, ont = 'ALL') %>% 
             data.frame(row.names = NULL) ) %>% 
  keep(~ nrow(.x) != 0)
write.xlsx(eGO, 'diffs.eGO.down_gene.xlsx')

#### IDO/AHR ####
source('/code/R_func/calcu_diff.R')
diffs <- readRDS('diffs.rds')

data <- map_df(names(diffs), \(x) 
               map_df(paste0(c('RS', 'AS', 'AD'), '_vs_HC'), \(y) {
                 filter(diffs[[x]][[y]], name %in% c('IDO1', 'AHR')) %>%
                   add_column(cell = x, comparison = y) } ) )
write.xlsx(data, 'diffs.IDO1_AHR.xlsx')

plot_data <- select(data, name, log2FC = avg_log2FC, padj = p_val_adj, cell, comparison) %>% 
  add_plab('padj', format = 2) %>% 
  mutate(label = paste0(ifelse(log2FC > 0, '+', '-'), '\n', plab)) %>% 
  select(-padj, -plab) %>% 
  spread('comparison', 'log2FC', fill = 0) %>% 
  gather('comparison', 'log2FC', -label, -cell, -name)

ggplot(plot_data, aes(comparison, cell)) +
  geom_tile(aes(fill = log2FC, width = 1, height = 1), color = '#ffffff', linewidth = 1) +
  geom_text(aes(label = label, lineheight = .8)) +
  facet_grid(cols = vars(name)) +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0)) +
  scale_fill_gradient2(low = '#619CFF', mid = '#ffffff', high = '#F8766D') +
  labs(x = '', y = '', title = 'LiH_2021') +
  coord_fixed() +
  theme_linedraw() +
  theme(axis.text.x = element_text(angle = 30, hjust = 1),
        axis.text = element_text(color = '#000000', size = 12),
        axis.ticks = element_blank(),
        panel.grid = element_blank())
ggsave('diffs.IDO1_AHR.pdf', width = 6, height = 3.5)
```

## ParkA_2021

```{R}
#### Monocyte ####
seurat <- readRDS('../../20250707/ParkA_2021/seurat.out.rds')
seurat$cell <- seurat@active.ident

seurat <- subset(seurat, cell %in% c('CD14_monocyte', 'CD16_monocyte'))

seurat <- NormalizeData(seurat, normalization.method = 'LogNormalize', scale.factor = 1e4, verbose = T) # 标准化
seurat <- FindVariableFeatures(seurat, selection.method = 'vst', nfeatures = 2000) # 筛选高变基因
VariableFeaturePlot(seurat, cols = c('grey','red'))
seurat <- ScaleData(seurat) # 数据归一化，这步骤有一步回归的分析，去除噪声
seurat <- RunPCA(seurat, features = VariableFeatures(seurat)) # PCA线性降维分析
ElbowPlot(seurat, ndims = 30) # 流石图协助选择PC维度 10
seurat <- RunHarmony(seurat, 'orig.ident') # Harmony去批次
seurat <- RunUMAP(seurat, dims = 1:10, reduction = 'harmony')
seurat <- RunTSNE(seurat, dims = 1:10, reduction = 'harmony')
seurat <- FindNeighbors(seurat, reduction = 'harmony', dims = 1:10)
seurat <- FindClusters(seurat, resolution = c(seq(0, 1.9, .2)))

map2(paste0('RNA_snn_res.', seq(0, 1.9, .2)), paste0('SNN: ', seq(0, 1.9, .2)), ~
       DimPlot(seurat, reduction = 'umap', group.by = .x, label = T) +
       ggtitle(.y) + 
       theme(aspect.ratio = 1) + 
       guides(color = 'none')) %>% 
  plot_grid(plotlist = ., nrow = 2)
ggsave('umap.SNN.dimplot.jpg', width = 20, height = 8)

#### 细胞标记 ####
# 细胞基因标记
markers <- list(
  CD8_T_cell = c('CD3D','CD8A','CD8B','CD3E','CD3'), 
  CD4_T_cell = c('CD3D','CD4','IL7R','LTB','CD3'), 
  gdT_cell = c('TRDV2','TRGV9'),
  NK_cell = c('NCAM1','KLRF1','FGFBP2','FCG3RA','CX3CR1','GNLY','NKG7','TYOBP','PRF1'), 
  B_cell = c('CD19','CD79A','CD79B','MS4A1'), # CD20->MS4A1
  Plasmablast = c('XBP1','RF4','PRDM1','PAX5'), # 浆母细胞
  Plasma_cell = c('CD79A','IGHG1','MZB1','SDC1'), # 浆细胞
  Neutrophils = c('FCGR3B','MMP9','CST3','LYZ','CSF3R'),
  CD14_monocyte = c('CD14','LYZ','CD33','FCN1'),
  CD16_monocyte = c('CD14','FCGR3A','CD33','LYN'),
  M1_Macrophage = c('CD80','CD86','INOS'), # 经典激活型巨噬细胞（classically activated macrophages）
  M2_Macrophage = c('CD163','CD206'), # 交替激活型巨噬细胞（alternatively activated macrophages）
  Endothelial_cell = c('PTPRB','PECAM1'),
  Platelet = c('PPBP','CD41'), # 血小板
  Erythroblast = c('MKI67','HBA1','HBB'), # 成红血细胞，红细胞成熟过程中的特定阶段细胞
  cDendritic_cell1 = c('CLEC9A','CADM1'), # conventional dendritic 传统树突状细胞1
  cDendritic_cell2 = c('CST3','COTL1','LYZ','DMXL2','CLEC10A','FCER1A'), # conventional dendritic 传统树突状细胞1
  pDendritic_cell = c('IL3RA','GZMB','SERPINF1','ITM2C'), # plasmacytoid dendritic 浆细胞样树突状细胞
  HSC = c('NRIP1','MECOM','PROM1','NKAIN2','CD34') # Hematopoietic Stem Cell 造血干细胞
  )

# featureplot
markers <- map(markers, \(x) x[x %in% rownames(seurat)])
max_len <- map_vec(markers, ~ length(.x)) %>% max()
map2(markers, names(markers), \(x, y) {
  p_text <- list(ggtext(data.frame(x = 1, y = 1), 'x', 'y', size = 14, face = 'bold',
                        label = stringr::str_to_title(gsub('_', ' ', y))) + 
                   theme_void())
  p_feats <- map(x, ~ FeaturePlot(seurat, reduction = 'tsne', features = .x) +
                   theme(aspect.ratio = 1))
  p_void <- list(ggtext(data.frame(x = 1, y = 1), 'x', 'y', size = 14, face = 'bold') + 
                   theme_void())
  cowplot::plot_grid(plotlist = c(p_text, p_feats, rep(p_void, times = max_len - length(x))),
                     nrow = 1) } ) %>% 
  cowplot::plot_grid(plotlist = ., align = 'v', ncol = 1)
ggsave('tsne.featureplot.jpg', width = 4.5 * (max_len + 1), height = 4.5 * length(markers),
       limitsize = F)

# marker2 
markers <- list(
  CD14_monocyte = c('CD14','LYZ','CD33','FCN1'),
  CD16_monocyte = c('CD14','FCGR3A','CD33','LYN') # FCGR3A -> CD
)

markers <- map(markers, \(x) x[x %in% rownames(seurat)])
max_len <- map_vec(markers, ~ length(.x)) %>% max()
plots <- map2(markers, names(markers), \(x, y) {
  p_text <- list(ggtext(data.frame(x = 1, y = 1), 'x', 'y', size = 14, face = 'bold',
                        label = stringr::str_to_title(gsub('_', ' ', y))) + 
                   theme_void())
  p_feats <- map(x, ~ FeaturePlot(seurat, reduction = 'tsne', features = .x) +
                   theme(aspect.ratio = 1))
  p_void <- list(ggtext(data.frame(x = 1, y = 1), 'x', 'y', size = 14, face = 'bold') + 
                   theme_void())
  cowplot::plot_grid(plotlist = c(p_text, p_feats, rep(p_void, times = max_len - length(x))), nrow = 1) } )
pdf('tsne.featureplot.pdf', width = 4.5 * (max_len + 1), height = 4.5)
plots
dev.off()

seurat <- SetIdent(seurat, value = 'RNA_snn_res.0.8')
DimPlot(seurat, reduction = 'umap', label = T, alpha = 1, raster = F) + 
  NoLegend() + theme(aspect.ratio = 1)
ggsave('umap.SNN.0.8.dimplot.pdf', width = 6, height = 6)

# 鉴定每个cluster中的marker
allmarkers <- FindAllMarkers(seurat, only.pos = T, min.pct = 0.25, logfc.threshold = 0.25)
saveRDS(allmarkers, 'allmarkers.cluster.rds')
write.xlsx(allmarkers, 'allmarkers.cluster.xlsx')

#### 细胞注释 ####
# CD14/CD16 markers
plot_data <- FetchData(seurat, vars = c('CD14', 'FCGR3A')) %>% 
  add_column(cell = seurat@active.ident) %>% 
  gather(key = 'gene', value = 'value', -cell)

ggplot(plot_data, aes(cell, value), color = factor(cell)) +
  geom_violin(aes(fill = cell), scale ='width') +
  facet_grid(gene ~ ., scales = 'free_y') +
  scale_y_continuous(expand = c(0, 0)) +
  scale_fill_manual(values = pald('rainbow3', 16)) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.title = element_blank(),
        axis.ticks.length = unit(1.6, 'mm'),
        axis.text = element_text(color = 'black', size = 10),
        legend.position = 'none',
        panel.spacing.y = unit(0, 'cm'),
        strip.text.y = element_text(angle = 0, size = 12, hjust = 0, face = 'italic'),
        strip.background.y = element_blank())
ggsave('violinplot.cluster.CD1x.pdf', width = 6, height = 3)

p1 <- FeaturePlot(seurat, reduction = 'tsne', features = c('CD14'),cols = c('#ffffff', '#225ea8')) +
  labs(title = 'CD14') +
  theme(aspect.ratio = 1,
        axis.ticks.length = unit(2, 'mm'),
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 10),
        plot.title = element_text(size = 12))
p2 <- FeaturePlot(seurat, reduction = 'tsne', features = 'FCGR3A', cols = c('#ffffff', '#225ea8')) +
  labs(title = 'CD16 (FCGR3A)') +
  theme(aspect.ratio = 1,
        axis.ticks.length = unit(2, 'mm'),
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 10),
        plot.title = element_text(size = 12))
cowplot::plot_grid(p1, p2)
ggsave('tsne.featureplot.CD1x.pdf', width = 9, height = 4)

# marker自动注释
map(markers, ~ filter(allmarkers, gene %in% .x) ) %>% 
  keep(~ nrow(.x) != 0) %>% 
  map(~ group_by(.x, cluster) %>% 
        group_modify(~ data.frame(match_n = nrow(.x), 
                                  genes = paste(.x$gene, collapse = ',')))) %>% 
  map2_df(names(.), ~ add_column(.x, gene = .y, .before = 1)) %>% 
  data.frame() %>% 
  arrange(cluster)

# 经典单核细胞 (Classical): CD14++ CD16-，约占单核细胞的90%，具有较强的吞噬和抗菌活性。 
# 中间单核细胞 (Intermediate): CD14+ CD16+，具有较高的CD14和相对低的CD16表达，约占单核细胞的10%。 
# 非经典单核细胞 (Non-classical): CD14- CD16++，相对较低的CD14表达和高CD16表达，主要在血管巡逻和监视中发挥作用。
# 这些亚群在免疫系统中发挥不同的功能，参与宿主的促炎防御机制、抗原呈递和监视等。
seurat <- RenameIdents(seurat,
                       '0' = 'Classical', '1' = 'Classical', '2' = 'Classical', 
                       '3' = 'Classical', '4' = 'Non-classical', '5' = 'Intermediate',
                       '6' = 'Megakaryocyte', '7' = 'T_cell', '8' = 'Classical', 
                       '9' = 'Classical')

# 疑难细胞群注释
filter(allmarkers, p_val_adj < 0.01 & cluster == '3') %>% 
  pull() %>% 
  scRNA_marker_match(tissue = 'peripheral_blood', org = 'human') %>% 
  select(-species, -tissue, -cell, -gene) %>% 
  filter(grepl('blood', item)) %>% 
  data.frame() %>% 
  head(10)

# 可视化
DimPlot(seurat, reduction = 'umap', label = T, alpha = 1, cols = 'Set3', raster = F) + 
  theme(aspect.ratio = 1) + NoLegend()
ggsave('umap.marker.dimplot.pdf', width = 6, height = 6)

DimPlot(seurat, reduction = 'umap', label = T, alpha = 1, split.by = 'group', raster = F,
        cols = 'Set3', label.size = 3) + theme(aspect.ratio = 1)
ggsave('umap.marker.dimplot.facet_by_group.pdf', width = 20, height = 5)

# 差异基因
allmarkers <- FindAllMarkers(seurat, only.pos = T, min.pct = 0.25, logfc.threshold = 0.25)
saveRDS(allmarkers, 'allmarkers.cell.rds')
write.xlsx(allmarkers, 'allmarkers.cell.xlsx')

# CD14/CD16 markers
plot_data <- FetchData(seurat, vars = c('CD14', 'FCGR3A')) %>% 
  add_column(cell = seurat@active.ident) %>% 
  gather(key = 'gene', value = 'value', -cell)

ggplot(plot_data, aes(cell, value), color = factor(cell)) +
  geom_violin(aes(fill = cell), scale ='width') +
  facet_grid(gene ~ ., scales = 'free_y') +
  scale_y_continuous(expand = c(0, 0)) +
  scale_fill_manual(values = colorRampPalette(pald('rainbow3'))(7)) +
  theme_bw() +
  theme(panel.grid = element_blank(),
        axis.title = element_blank(),
        axis.ticks.length = unit(1.6, 'mm'),
        axis.text = element_text(color = 'black', size = 10),
        axis.text.x = element_text(color = 'black', size = 10, angle = 45, hjust = 1),
        legend.position = 'none',
        panel.spacing.y = unit(0, 'cm'),
        strip.text.y = element_text(angle = 0, size = 12, hjust = 0, face = 'italic'),
        strip.background.y = element_blank())
ggsave('violinplot.cell.CD1x.pdf', width = 4, height = 3)

# 保存seurat对象
saveRDS(seurat, 'seurat.out.rds')

#### 差异分析 ####
group_level <- c('SFTS', 'REC', 'Fatal')
cell_level <- levels(Idents(seurat))[1:3]

# 所有细胞类型
diffs <- map(cell_level, \(x) 
             map(group_level, \(y) 
                 try(FindMarkers(subset(seurat, idents = x), ident.1 = y,
                                 ident.2 = 'HC', group.by = 'group') %>%
                       rownames_to_column('name') ) ) %>%
               set_names(paste0(group_level, '_vs_HC')) %>% 
               discard(~ !is.data.frame(.x)) ) %>% 
  set_names(cell_level)
saveRDS(diffs, 'diffs.rds')

diffs <- list_flatten(diffs)
write.xlsx(diffs, 'diffs.xlsx')

#### GSEA KEGG ####
options(clusterProfiler.download.method = 'curl', timeout = 120)
pacman::p_load(org.Hs.eg.db, clusterProfiler, BiocParallel, enrichplot)
register(SerialParam())

gene_info <- AnnotationDbi::select(org.Hs.eg.db, keys(org.Hs.eg.db), 
                                   keytype = 'ENTREZID', columns = c('SYMBOL'))

gseKEGG <- map(diffs, ~ mutate(.x, ENTREZID = gene_info$ENTREZID[match(name, gene_info$SYMBOL)]) %>%
                 filter(!is.na(ENTREZID)) %>% 
                 pull(avg_log2FC, name = ENTREZID) %>% 
                 sort(decreasing = T) %>% 
                 gseKEGG(organism = 'hsa', pvalueCutoff = 1) %>% 
                 data.frame() )
write.xlsx(gseKEGG, 'diffs.gseKEGG.xlsx')

# 气泡图
kegg_info <- read.delim('/database/KEGG/map/br08901.tsv') %>% 
  mutate(lvC = gsub('map', 'hsa', lvC))

colors <- c('Cellular Processes' = '#66c2a5',
            'Environmental Information Processing' = '#fc8d62',
            'Genetic Information Processing' = '#8da0cb',
            'Metabolism' = '#e78ac3',
            'Organismal Systems' = '#A6D854')

plot_data <- map2_df(gseKEGG, names(gseKEGG), \(x, y)
                     dplyr::filter(data.frame(x)) %>% 
                       dplyr::select(name = Description, id = ID, NES, p.adjust) %>% 
                       data.frame(row.names = NULL) %>% 
                       add_column(group = y) ) %>% 
  left_join(kegg_info, by = c('id' = 'lvC')) %>% 
  filter(lvA %in% c('Metabolism','Genetic Information Processing',
                    'Environmental Information Processing', 'Cellular Processes',
                    'Organismal Systems')) %>% 
  arrange(lvA) %>% 
  mutate(name = factor(name, unique(name)),
         color = colors[lvA],
         name = glue::glue('<p style="color:{color}">{name} </p>') ) %>% 
  mutate(plab = ifelse(p.adjust < 0.05, 'sign', 'non-sign')) %>% 
  filter(p.adjust < 0.05) %>% 
  arrange(group)

ggscatter(plot_data, 'group', 'name', fill = 'NES', shape = 21, 
          xlab = '', ylab = '', size = 3) +
  scale_fill_gradient2(high = '#d53e4f', mid = '#ffffbf', low = '#3288bd') +
  coord_fixed() +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 60, hjust = 1, size = 8),
        axis.text.y = ggtext::element_markdown(size = 8),
        axis.ticks.length = unit(1.6, 'mm'),
        panel.spacing.x = unit(0, 'cm'),
        panel.grid = element_line(linewidth = .3, linetype = 'dashed'))
ggsave('diffs.gseKEGG.pdf', width = 6, height = 14)

#### ORA KEGG ####
eKEGG <- map(diffs, ~ filter(.x, p_val_adj < .05 & abs(avg_log2FC) > .25) %>% 
               mutate(ENTREZID = gene_info$ENTREZID[match(name, gene_info$SYMBOL)]) %>%
               pull(ENTREZID) %>% 
               na.omit %>% 
               enrichKEGG(organism = 'hsa', pvalueCutoff = 1, qvalueCutoff = 1) %>% 
               data.frame(row.names = NULL) ) %>% 
  keep(~ nrow(.x) != 0)
write.xlsx(eKEGG, 'diffs.eKEGG.all_gene.xlsx')

# up genes
eKEGG <- map(diffs, ~ filter(.x, p_val_adj < .05 & avg_log2FC > .25) %>% 
               mutate(ENTREZID = gene_info$ENTREZID[match(name, gene_info$SYMBOL)]) %>%
               pull(ENTREZID) %>% 
               na.omit %>% 
               enrichKEGG(organism = 'hsa', pvalueCutoff = 1, qvalueCutoff = 1) %>% 
               data.frame(row.names = NULL) ) %>% 
  keep(~ nrow(.x) != 0)
write.xlsx(eKEGG, 'diffs.eKEGG.up_gene.xlsx')

# down genes
eKEGG <- map(diffs, ~ filter(.x, p_val_adj < .05 & avg_log2FC < -.25) %>% 
               mutate(ENTREZID = gene_info$ENTREZID[match(name, gene_info$SYMBOL)]) %>%
               pull(ENTREZID) %>% 
               na.omit %>% 
               enrichKEGG(organism = 'hsa', pvalueCutoff = 1, qvalueCutoff = 1) %>% 
               data.frame(row.names = NULL) ) %>% 
  keep(~ nrow(.x) != 0)
write.xlsx(eKEGG, 'diffs.eKEGG.down_gene.xlsx')

#### ORA GO ####
# total genes
eGO <- map(diffs, ~ filter(.x, p_val_adj < .05 & abs(avg_log2FC) > .25) %>% 
             pull(name) %>% 
             enrichGO(OrgDb = 'org.Hs.eg.db', keyType = 'SYMBOL',
                      pvalueCutoff = .2, qvalueCutoff = .2, ont = 'ALL') %>% 
             data.frame(row.names = NULL) ) %>% 
  keep(~ nrow(.x) != 0)
write.xlsx(eGO, 'diffs.eGO.all_gene.xlsx')

# up genes
eGO <- map(diffs, ~ filter(.x, p_val_adj < .05 & avg_log2FC > .25) %>% 
             pull(name) %>% 
             na.omit %>% 
             enrichGO(OrgDb = 'org.Hs.eg.db', keyType = 'SYMBOL',
                      pvalueCutoff = .2, qvalueCutoff = .2, ont = 'ALL') %>% 
             data.frame(row.names = NULL) ) %>% 
  keep(~ nrow(.x) != 0)
write.xlsx(eGO, 'diffs.eGO.up_gene.xlsx')

# down genes
eGO <- map(diffs, ~ filter(.x, p_val_adj < .05 & avg_log2FC < -.25) %>% 
             pull(name) %>%  
             na.omit %>% 
             enrichGO(OrgDb = 'org.Hs.eg.db', keyType = 'SYMBOL',
                      pvalueCutoff = .2, qvalueCutoff = .2, ont = 'ALL') %>% 
             data.frame(row.names = NULL) ) %>% 
  keep(~ nrow(.x) != 0)
write.xlsx(eGO, 'diffs.eGO.down_gene.xlsx')

#### IDO/AHR ####
source('/code/R_func/calcu_diff.R')
diffs <- readRDS('diffs.rds')

data <- map_df(names(diffs), \(x) 
               map_df(paste0(c('SFTS', 'REC', 'Fatal'), '_vs_HC'), \(y) {
                 if (!is.null(diffs[[x]][[y]])) {
                   filter(diffs[[x]][[y]], name %in% c('IDO1', 'AHR')) %>%
                     add_column(cell = x, comparison = y)
                 } } ) )
write.xlsx(data, 'diffs.IDO1_AHR.xlsx')

plot_data <- select(data, name, log2FC = avg_log2FC, padj = p_val_adj, cell, comparison) %>% 
  add_plab('padj', format = 2) %>% 
  mutate(label = paste0(ifelse(log2FC > 0, '+', '-'), '\n', plab)) %>% 
  select(-padj, -plab) %>% 
  spread('comparison', 'log2FC', fill = 0) %>% 
  gather('comparison', 'log2FC', -label, -cell, -name)

ggplot(plot_data, aes(comparison, cell)) +
  geom_tile(aes(fill = log2FC, width = 1, height = 1), color = '#ffffff', linewidth = 1) +
  geom_text(aes(label = label, lineheight = .8)) +
  facet_grid(cols = vars(name)) +
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0)) +
  scale_fill_gradient2(low = '#619CFF', mid = '#ffffff', high = '#F8766D') +
  labs(x = '', y = '', title = 'ParkA_2021') +
  coord_fixed() +
  theme_linedraw() +
  theme(axis.text.x = element_text(angle = 30, hjust = 1),
        axis.text = element_text(color = '#000000', size = 12),
        axis.ticks = element_blank(),
        panel.grid = element_blank())
ggsave('diffs.IDO1_AHR.pdf', width = 6, height = 3.5)
```
